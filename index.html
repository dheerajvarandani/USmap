<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sabio | AppScience | US Map</title>

  <!-- External libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#0a0a0f;
      --surface:#14141d;
      --border:rgba(255,255,255,.08);
      --ink:#f1f5f9;
      --muted:#94a3b8;
      --brand:#ff8000;
      --brand-2:#ff5722;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: Inter, ui-sans-serif, system-ui;
      background: radial-gradient(circle at top left, #100131, #151574 100%),
                  linear-gradient(135deg, #ff800066, #0a0a0f 70%);
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background:rgba(20,20,30,.7);
      border-bottom:1px solid var(--border);
    }
    .nav{ max-width:1200px; margin:0 auto; padding:1rem 5vw; display:flex; align-items:center; justify-content:space-between; }
    .brand{ display:flex; align-items:center; gap:.75rem; font-weight:800; color:var(--ink); }
    .brand img{ height:36px; width:auto }
    .kicker{ font-size:.85rem; color:var(--muted) }

    .wrap{ max-width:1200px; margin:0 auto; padding:2rem 5vw; }

    .row{ display:grid; grid-template-columns: 2fr 0.85fr; gap:1.5rem; }
    .panel{ background:rgba(20,20,30,.75); border:1px solid var(--border); border-radius:20px; overflow:hidden; box-shadow:0 12px 32px rgba(0,0,0,.6); backdrop-filter: blur(12px); }
    .panel-head{ padding:1rem 1.25rem; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border); }
    .panel-head h2{ font-size:1rem; font-weight:700; color:var(--brand); }
    .panel-body{ padding:1rem; }

    .legend{ display:flex; gap:.6rem; flex-wrap:wrap }
    .pill{ background:rgba(255,255,255,.04); border:1px solid var(--border); padding:.4rem .8rem; border-radius:999px; font-size:.8rem; display:flex; align-items:center; gap:.4rem; }
    .dot{ width:10px; height:10px; border-radius:999px }

    #map{ width:100%; height:min(70vh,600px); position:relative; border-radius:14px; overflow:hidden; }
    svg{ width:100%; height:100% }
    .state{ fill:#2a2a3d; stroke:#9797c4; stroke-width:.6; cursor:pointer; transition:.25s; }
    .state[data-race="no"]{ fill:#1a1a25 }
    .state[data-race="general"]{ fill:#ff800033 }
    .state[data-race="battleground"]{ fill:#ff800077 }
    .state[data-race="important"]{ fill:#ff8000cc }
    .state:hover{ stroke-width:1.2; filter:brightness(1.3) }

    #tooltip{ position:absolute; display:none; pointer-events:none; }
    .tt{ background:#14141d; border:1px solid var(--border); border-radius:12px; padding:.8rem 1rem; box-shadow:0 12px 40px rgba(0,0,0,.5); max-width:260px; }
    .tt h3{ font-size:1rem; font-weight:700; color:var(--brand) }
    .tt p{ font-size:.85rem; color:var(--muted) }

    .details h3{ font-size:1.1rem; color:var(--brand) }
    .subtle{ color:var(--muted); font-size:.9rem }
    .grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:.75rem }
    .stat{ background:rgba(255,255,255,.02); border:1px solid var(--border); border-radius:12px; padding:.75rem }
    .stat label{ display:block; font-size:.75rem; color:var(--muted); margin-bottom:.25rem }
    .stat strong{ font-size:1.1rem; color:#fff }

    .group{ margin-top:1rem }
    .group h4{ font-size:.9rem; margin-bottom:.4rem; color:var(--muted) }
    .list{ border:1px solid var(--border); border-radius:12px; overflow:hidden; background:rgba(255,255,255,.02) }
    .item{ display:flex; justify-content:space-between; padding:.6rem .8rem; border-bottom:1px solid var(--border); font-size:.9rem }
    .item:last-child{ border-bottom:none }

    .insights{ margin-top:1rem; display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:1rem }
    .card{ background:rgba(255,255,255,.03); border:1px solid var(--border); border-radius:14px; padding:1rem; box-shadow:0 8px 28px rgba(0,0,0,.5); min-height:120px }
    .card h5{ font-size:.85rem; color:var(--brand); margin-bottom:.5rem }

    footer{ text-align:center; font-size:.85rem; color:var(--muted); padding:2rem 0 }

    .icon-btn{ width:36px; height:36px; border-radius:8px; background:rgba(255,255,255,.04); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; cursor:pointer }

    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index:60 }
    .modal{ background:#14141d; border:1px solid var(--border); border-radius:16px; box-shadow:0 24px 64px rgba(0,0,0,.7); width:min(560px,92vw); }
    .modal header{ display:flex; justify-content:space-between; align-items:center; padding:1rem 1.25rem; border-bottom:1px solid var(--border) }
    .modal h3{ font-size:1rem; color:var(--brand) }
    .modal .content{ padding:1rem 1.25rem; color:var(--muted) }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand">
        <img src="./assets/logo.png" alt="Logo" />
        <div>U.S. State Insights</div>
      </div>
      <div style="display:flex; gap:.6rem; align-items:center">
        <span class="kicker">Interactive map</span>
        <button id="infoBtn" class="icon-btn" aria-label="About">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="var(--brand)" stroke-width="1.5"/><path d="M12 8h.01M12 11v5" stroke="var(--brand)" stroke-width="1.5" stroke-linecap="round"/></svg>
        </button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="row">
      <article class="panel">
        <div class="panel-head">
          <h2>Interactive U.S. Map</h2>
          <div class="legend">
            <span class="pill"><span class="dot" style="background:#1a1a25"></span>No Race</span>
            <span class="pill"><span class="dot" style="background:#ff800033"></span>General</span>
            <span class="pill"><span class="dot" style="background:#ff800077"></span>Battleground</span>
            <span class="pill"><span class="dot" style="background:#ff8000cc"></span>Important</span>
          </div>
        </div>
        <div class="panel-body">
          <div id="map"></div>
          <div id="tooltip"><div class="tt"></div></div>
        </div>
      </article>

      <aside id="sidebar" class="panel details">
        <div class="panel-head">
          <h2>State Details</h2>
        </div>
        <div class="panel-body" id="detailsBody"></div>
      </aside>
    </section>

    <section class="panel" style="margin-top:1.25rem">
      <div class="panel-head"><h2>Key Insights</h2></div>
      <div class="panel-body"><div id="insightGrid" class="insights"></div></div>
    </section>
  </main>

  <!-- Modal -->
  <div id="aboutModal" class="modal-backdrop">
    <div class="modal">
      <header>
        <h3>About This Map</h3>
        <button id="closeModal" class="icon-btn" aria-label="Close">✕</button>
      </header>
      <div class="content">
        <p>This HH Graph interface presents demographic segments and key insights for each U.S. state. Data is sourced from your Excel sheet, styled with a modern dark gradient theme and orange highlights.</p>
      </div>
    </div>
  </div>

  <footer>© All rights reserved.</footer>

  <script>
  (function(){
    // ===== Modal controls =====
    const infoBtn = document.getElementById('infoBtn');
    const aboutModal = document.getElementById('aboutModal');
    const closeModal = document.getElementById('closeModal');
    if(infoBtn){ infoBtn.addEventListener('click', ()=> aboutModal.style.display='flex'); }
    if(closeModal){ closeModal.addEventListener('click', ()=> aboutModal.style.display='none'); }
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') aboutModal.style.display='none'; });

    // ===== App State =====
    let stateData = new Map();
    let currentState = null;

    // ===== Helpers =====
    const getRaceCategory = (type)=>{
      if(!type || /no race/i.test(type)) return 'no';
      if(/battleground/i.test(type)) return 'battleground';
      if(/important/i.test(type)) return 'important';
      return 'general';
    };
    const categoryFill = (type)=>{
      if(type==='no') return '#1a1a25';
      if(type==='battleground') return '#ff7b3977';
      if(type==='important') return '#ff7b39cc';
      return '#ff7b3944';
    };
    const fmtNum = (n)=> n!=null && n!=='' ? Number(n).toLocaleString() : '-';
    const fmtPct = (n)=> n!=null && n!=='' ? `${n}%` : '-';
    function extractTop(row, start){
      return [
        {Name: row[start],   Data: row[start+1]},
        {Name: row[start+3], Data: row[start+4]},
        {Name: row[start+6], Data: row[start+7]},
      ].filter(x=>x && x.Name);
    }

    // ===== Rendering =====
    function renderMap(us){
      const mapEl = document.getElementById('map');
      const svg = d3.select(mapEl).append('svg');
      const {clientWidth:W, clientHeight:H} = mapEl;
      svg.attr('viewBox', `0 0 ${W} ${H}`);

      const projection = d3.geoAlbersUsa().translate([W/2, H/2]).scale(W*1.25);
      const path = d3.geoPath(projection);
      const states = topojson.feature(us, us.objects.states).features;

      const g = svg.append('g');
      g.selectAll('path').data(states).enter().append('path')
        .attr('class','state')
        .attr('d', path)
        .attr('data-race', d => getRaceCategory(stateData.get(d.properties.name)?.["Race Type"]))
        .on('mouseenter', (ev,d)=> showTooltip(ev, d.properties.name))
        .on('mousemove', positionTooltip)
        .on('mouseleave', hideTooltip)
        .on('click', (ev,d)=> selectState(d.properties.name));
    }

    function showTooltip(ev, name){
      const entry = stateData.get(name);
      const tt = document.querySelector('#tooltip');
      const box = tt.querySelector('.tt');
      const cat = getRaceCategory(entry?.["Race Type"]);
      box.innerHTML = `
        <h3>${name}</h3>
        <p>${entry?.["Race Type"] ?? 'No Race'} · <span style="color:${categoryFill(cat)}">${cat}</span></p>
      `;
      tt.style.display='block';
      positionTooltip(ev);
    }
    function positionTooltip(ev){
const tt = document.getElementById('tooltip');
const map = document.getElementById('map');
const rect = map.getBoundingClientRect();
// Use viewport coords (clientX/Y) minus map's top-left to anchor inside the map
let x = ev.clientX - rect.left + 16;
let y = ev.clientY - rect.top + 16;
// Clamp so tooltip stays within the map bounds
const pad = 8;
const ttBox = tt.firstElementChild?.getBoundingClientRect();
const w = ttBox ? ttBox.width : 260;
const h = ttBox ? ttBox.height : 120;
x = Math.max(pad, Math.min(x, rect.width - w - pad));
y = Math.max(pad, Math.min(y, rect.height - h - pad));
tt.style.left = x + 'px';
tt.style.top = y + 'px';
}
    function hideTooltip(){ document.getElementById('tooltip').style.display='none'; }

    function selectState(name){
      currentState = name;
      const entry = stateData.get(name);
      renderDetails(name, entry);
      renderInsights(entry);
    }

    function renderDetails(name, data){
      const el = document.getElementById('detailsBody');
      if(!data){ el.innerHTML = `<div class="subtle">Select a state on the map.</div>`; return; }
      const pop = `
        <div class="grid">
          <div class="stat"><label>Total Population</label><strong>${fmtNum(data["Total Population"])}</strong></div>
          <div class="stat"><label>Eligible Voter</label><strong>${fmtPct(data["Eligible Voter"])}</strong></div>
          <div class="stat"><label>White</label><strong>${fmtPct(data["% White"])}</strong></div>
          <div class="stat"><label>Hispanic</label><strong>${fmtPct(data["% Hispanic"])}</strong></div>
          <div class="stat"><label>African American</label><strong>${fmtPct(data["% African American"])}</strong></div>
          <div class="stat"><label>Asian</label><strong>${fmtPct(data["% Asian"])}</strong></div>
        </div>`;

        const generations = `
        <div class="grid">
          <div class="stat"><label>Gen Z (18–29)</label><strong>${fmtPct(data["Gen Z"])}</strong></div>
          <div class="stat"><label>Millennials (30–44)</label><strong>${fmtPct(data["Millennials"])}</strong></div>
          <div class="stat"><label>Gen X (45–59)</label><strong>${fmtPct(data["Gen X"])}</strong></div>
          <div class="stat"><label>Boomers (60–79)</label><strong>${fmtPct(data["Boomers"])}</strong></div>
        </div>`;

      el.innerHTML = `
        <h3>${name}</h3>
        <div class="subtle" style="margin:.1rem 0 .6rem">${data["Race Type"] ?? ''}${data["Race Description"]? ' • ' + data["Race Description"] : ''}</div>
        ${data["Narrative"]? `<div class="group"><h4>Narrative</h4><div class="subtle">${data["Narrative"]}</div></div>`:''}
        <div class="group"><h4>Population</h4>${pop}</div>
        <div class="group"><h4>Generations</h4>${generations}</div>
      `;

    }

    function renderInsights(data){
      const grid = document.getElementById('insightGrid');
      const categories = [
        ["Top Shows", data?.["Top Shows"]],
        ["Top Channels", data?.["Top Channels"]],
        ["Top Mobile Apps", data?.["Top Mobile Apps"]],
        ["Top Location Visits", data?.["Top Location Visits"]],
        ["Top Segments", data?.["Top Segments"]]
      ];
      grid.innerHTML = categories.map(([label, items])=>{
        const rows = (items && items.length)
          ? items.map(i=>`<div class="item"><span>${i.Name}</span><span>${i.Data ?? '-'}</span></div>`).join('')
          : `<div class="item"><span>-</span><span>-</span></div>`;
        return `<div class="card"><h5>${label}</h5><div class="list">${rows}</div></div>`;
      }).join('');
    }

    // ===== Init =====
    function init(){
      Promise.all([
        d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json'),
        fetch('2025 - Top Political Races and Data.xlsx').then(r=>{ if(!r.ok) throw new Error('Data file missing'); return r.arrayBuffer(); })
      ])
      .then(([us, buf])=>{
        const wb = XLSX.read(buf,{type:'array'});
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const table = XLSX.utils.sheet_to_json(sheet,{header:1});
        const rows = table.slice(2);
        rows.forEach(row=>{
          const state = row[0]; if(!state) return;
          const entry = {
            "Race Type": row[2],
            "Race Description": row[3],
            "Total Population": row[4],
            "% White": row[5], "% Hispanic": row[6], "% Asian": row[7], "% African American": row[8],
            "Narrative": row[9],
            "Eligible Voter": row[55],
            "Gen Z": row[56],         // column G
            "Millennials": row[57],   // column H
            "Gen X": row[58],         // column I
            "Boomers": row[59],       // column J
            "Top Shows": extractTop(row, 10),
            "Top Channels": extractTop(row, 19),
            "Top Mobile Apps": extractTop(row, 28),
            "Top Location Visits": extractTop(row, 37),
            "Top Segments": extractTop(row, 46)
          };

          stateData.set(state, entry);
        });
        renderMap(us);
        document.getElementById('detailsBody').innerHTML = `<div class="subtle">Select a state on the map.</div>`;
        renderInsights(null);
      })
      .catch(err=>{
        document.getElementById('map').innerHTML = `<p style="color:#ff7b39;padding:2rem;text-align:center">${err.message}</p>`;
      });
    }

    // Kick off once libs are ready
    if(window.XLSX){ init(); }
    else { window.addEventListener('load', init); }
  })();
  </script>
</body>
</html>
